{% extends 'main/base.html' %}

{% block title %}Student Dashboard{% endblock %}

{% block extra_css %}
<style>
    .layout-wrapper {
        display: flex;
        margin-top: 0;
    }

    .sidebar-wrapper {
        display: flex;
        flex-direction: column;
        background-color: #0277BD;
        transition: width 0.3s ease;
        width: 220px;
        min-height: calc(100vh - 56px);
    }

    .sidebar-wrapper.collapsed {
        width: 60px;
    }

    .toggle-btn {
        background-color: #0277BD;
        border: none;
        color: white;
        padding: 10px;
        cursor: pointer;
        text-align: left;
    }

    .sidebar {
        padding: 1rem;
        flex-grow: 1;
    }

    .sidebar h5 {
        color: white;
        margin-bottom: 1.5rem;
    }

    .sidebar a {
        display: flex;
        align-items: center;
        color: #e0f7fa;
        text-decoration: none;
        padding: 0.6rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.3rem;
        white-space: nowrap;
        transition: background-color 0.2s ease;
    }

    .sidebar a:hover,
    .sidebar a.active {
        background-color: #01579B;
    }

    .sidebar a i {
        margin-right: 0.6rem;
        font-size: 1.2rem;
        vertical-align: middle;
    }

    .sidebar-wrapper.collapsed .sidebar h5 {
        display: none;
    }

    .sidebar-wrapper.collapsed .sidebar a {
        justify-content: center;
    }

    .sidebar-wrapper.collapsed .sidebar a i {
        margin-right: 0;
        font-size: 1.4rem;
    }

    .sidebar-wrapper.collapsed .sidebar a span {
        display: none;
    }

    .main-content {
        flex-grow: 1;
        padding: 2rem;
        background-color: #f8f9fa;
        min-height: calc(100vh - 56px);
    }
</style>
{% endblock %}

{% block content %}
<div class="layout-wrapper">

    <!-- Sidebar -->
    <div class="sidebar-wrapper" id="sidebarWrapper">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
        <div class="sidebar">
            <h5>Student Panel</h5>
            <a href="#profile" class="sidebar-link" data-url="{% url 'view_profile' %}">
                <i class="bi bi-person-circle"></i>
                <span>Profile</span>
            </a>
            <a href="#seminars" class="sidebar-link" data-url="{% url 'available_seminars' %}">
                <i class="bi bi-journal-bookmark-fill"></i>
                <span>Seminars</span>
            </a>
            <a href="#groups" class="sidebar-link" data-url="{% url 'my_groups' %}">
                <i class="bi bi-people-fill"></i>
                <span>My Groups</span>
            </a>
            <a href="#registered" class="sidebar-link" data-url="{% url 'registered_seminars' %}">
                <i class="bi bi-check-circle-fill"></i>
                <span>Registered Seminars</span>
            </a>
            <a href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <h3>Welcome to Seminar Management System, {{ student.user.first_name }}</h3>
        <p>Select an option from the sidebar to get started.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleSidebar() {
        const wrapper = document.getElementById('sidebarWrapper');
        wrapper.classList.toggle('collapsed');
    }

    document.addEventListener("DOMContentLoaded", function () {
        const links = document.querySelectorAll(".sidebar-link");
        const mainContent = document.getElementById("mainContent");

        function loadContent(url) {
            fetch(url, {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to load content");
                return response.text();
            })
            .then(html => {
                mainContent.innerHTML = html;
            })
            .catch(err => {
                mainContent.innerHTML = `<div class="alert alert-danger">Error loading content.</div>`;
                console.error(err);
            });
        }

        // Load content from hash on initial page load
        const hash = window.location.hash;
        if (hash) {
            const target = document.querySelector(`.sidebar-link[href="${hash}"]`);
            if (target) {
                loadContent(target.dataset.url);
            }
        }

        // Sidebar link click handler
        links.forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const url = this.dataset.url;
                const hash = this.getAttribute('href');
                if (!url) return;

                window.history.pushState(null, '', hash);
                loadContent(url);
            });
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', function () {
            const hash = window.location.hash;
            const target = document.querySelector(`.sidebar-link[href="${hash}"]`);
            if (target) loadContent(target.dataset.url);
        });

        // Handle seminar register button AJAX
        document.addEventListener("submit", function (e) {
            if (e.target.classList.contains("register-form")) {
                e.preventDefault();
                const form = e.target;
                const url = form.action;
                const formData = new FormData(form);

                fetch(url, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const alertType = {
                        success: 'alert-success',
                        error: 'alert-danger',
                        info: 'alert-info'
                    }[data.status] || 'alert-secondary';

                    const alertDiv = document.createElement("div");
                    alertDiv.className = `alert ${alertType} mt-2 mb-0`;
                    alertDiv.textContent = data.message;
                    form.appendChild(alertDiv);

                    // Reload seminar list after success
                    if (data.status === "success") {
                        setTimeout(() => {
                            const seminarLink = document.querySelector('.sidebar-link[href="#seminars"]');
                            if (seminarLink) seminarLink.click();
                        }, 1000);
                    }

                    setTimeout(() => alertDiv.remove(), 3000);
                })
                .catch(err => {
                    console.error("Registration failed", err);
                });
            }
        });
    });
</script>
{% endblock %}
